# Mean
zero <- c(0,0,0,0,0)
y0   <- zero #in standard space not probability
e1<-1

#Change the rated capacity and deflection here (the only thing that's should be changed)
Ecv <- 1140

deflection <- 1400

while (e1>0.0001){
# CDF in normal space
U1   <- pnorm(y0[1],0,1)
U2   <- pnorm(y0[2],0,1)  
U3   <- pnorm(y0[3],0,1)
U4   <- pnorm(y0[4],0,1)
U5   <- pnorm(y0[5],0,1)

#real value
x1 <- (4.38*(-log(1-U1))^(1/1.7)) #velocity
x2 <- invcdf(uniformdistribution(8000,260000),U2) #displacement
x3 <- invcdf(gammadistribution(alpha=1.19,beta=1/0.27),U3) #angle
x4 <- qnorm(U4,1,0.033)
x5 <- qnorm(U5,15,5)

#Jacobian
Jyx11 <- pdf(Weibull(1.7,4.38),x1)/pdf(Normal(0,1),y0[1])
Jyx22 <- pdf(Uniform(8000,260000),x2)/pdf(Normal(0,1),y0[2])
Jyx33 <- pdf(Gamma(1.19,1/0.27),x3)/pdf(Normal(0,1),y0[3])
Jyx44 <- pdf(Normal(1,0.033),x4)/pdf(Normal(0,1),y0[4])
Jyx55 <- pdf(Normal(15,5),x5)/pdf(Normal(0,1),y0[5])

Jyx <- rbind(c(Jyx11,0,0,0,0),c(0,Jyx22,0,0,0),c(0,0,Jyx33,0,0),c(0,0,0,Jyx44,0),c(0,0,0,0,Jyx55))
Jxy <- inv(Jyx)

#limit state function
v      <- x1
M      <- x2
angles <- x3
MF   <- x4
temp <- x5


Lpp   <- ((M)^0.3858)*3.279
D     <- ((M)^0.2321)*0.9519
B     <- ((M)^0.33339)*0.8528
Cb    <- M/(Lpp*B*D*1.02)
R     <- sqrt((Lpp/4)^2+(B/2)^2)
K     <- (0.19*Cb+0.11)*Lpp
gamma <- 90-angles-asin(B/(2*R))
Ce    <- (K^2+R^2*(cospi(gamma/180))^2)/(K^2+R^2)
Cm    <- 1+pi*D/(2*Cb*B)
VF    <- -0.056*log(0.72*deflection/(0.74*v*10))+1.2011
TF    <- -3*10^-6*(temp^3)+0.0002*(temp^2)-0.0058*temp+1.0533

g     <- Ecv*VF*MF*TF-0.5*M*(v/100)^2*Cm*Ce

#gradien
gradg1 <- (6391*MF*((5289050460814003*temp^4)/75557863725914323419136 - (1770887431076117*temp^3)/295147905179352825856 + temp^2/5000 - (37*temp)/10000 + 10651/10000))/(125*v) - (M*v*((15152847288669*pi)/(10000000000000*M^(3/20)) + 1)*(cos((pi*(angles + asin((533*M^(33339/100000))/(1250*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500)^(1/2))) - 90))/180)^2*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500) + (10751841*M^(1929/2500)*((3125000000*M^(4871/100000))/44655661557 + 11/100)^2)/1000000))/(10000*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500 + (10751841*M^(1929/2500)*((3125000000*M^(4871/100000))/44655661557 + 11/100)^2)/1000000))
gradg2 <-(45458541866007*v^2*pi*(cos((pi*(angles + asin((533*M^(33339/100000))/(1250*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500)^(1/2))) - 90))/180)^2*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500) + (10751841*M^(1929/2500)*((3125000000*M^(4871/100000))/44655661557 + 11/100)^2)/1000000))/(4000000000000000000*M^(3/20)*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500 + (10751841*M^(1929/2500)*((3125000000*M^(4871/100000))/44655661557 + 11/100)^2)/1000000)) - (v^2*((15152847288669*pi)/(10000000000000*M^(3/20)) + 1)*(cos((pi*(angles + asin((533*M^(33339/100000))/(1250*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500)^(1/2))) - 90))/180)^2*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500) + (10751841*M^(1929/2500)*((3125000000*M^(4871/100000))/44655661557 + 11/100)^2)/1000000))/(20000*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500 + (10751841*M^(1929/2500)*((3125000000*M^(4871/100000))/44655661557 + 11/100)^2)/1000000)) - (M*v^2*((15152847288669*pi)/(10000000000000*M^(3/20)) + 1)*((5324003*((3125000000*M^(4871/100000))/44655661557 + 11/100))/(72632976*M^(17969/100000)) + cos((pi*(angles + asin((533*M^(33339/100000))/(1250*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500)^(1/2))) - 90))/180)^2*(20740301289/(40000000000*M^(571/2500)) + 9471243171/(78125000000*M^(16661/50000))) + (20740301289*((3125000000*M^(4871/100000))/44655661557 + 11/100)^2)/(2500000000*M^(571/2500)) - (pi*cos((pi*(angles + asin((533*M^(33339/100000))/(1250*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500)^(1/2))) - 90))/180)*sin((pi*(angles + asin((533*M^(33339/100000))/(1250*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500)^(1/2))) - 90))/180)*(17769687/(125000000*M^(66661/100000)*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500)^(1/2)) - (533*M^(33339/100000)*(20740301289/(40000000000*M^(571/2500)) + 9471243171/(78125000000*M^(16661/50000))))/(2500*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500)^(3/2)))*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500))/(90*(1 - (284089*M^(33339/50000))/((268796025*M^(1929/2500))/256 + 284089*M^(33339/50000)))^(1/2))))/(20000*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500 + (10751841*M^(1929/2500)*((3125000000*M^(4871/100000))/44655661557 + 11/100)^2)/1000000)) + (M*v^2*((15152847288669*pi)/(10000000000000*M^(3/20)) + 1)*(cos((pi*(angles + asin((533*M^(33339/100000))/(1250*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500)^(1/2))) - 90))/180)^2*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500) + (10751841*M^(1929/2500)*((3125000000*M^(4871/100000))/44655661557 + 11/100)^2)/1000000)*((5324003*((3125000000*M^(4871/100000))/44655661557 + 11/100))/(72632976*M^(17969/100000)) + 20740301289/(40000000000*M^(571/2500)) + 9471243171/(78125000000*M^(16661/50000)) + (20740301289*((3125000000*M^(4871/100000))/44655661557 + 11/100)^2)/(2500000000*M^(571/2500))))/(20000*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500 + (10751841*M^(1929/2500)*((3125000000*M^(4871/100000))/44655661557 + 11/100)^2)/1000000)^2)
gradg3 <- (M*v^2*pi*cos((pi*(angles + asin((533*M^(33339/100000))/(1250*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500)^(1/2))) - 90))/180)*sin((pi*(angles + asin((533*M^(33339/100000))/(1250*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500)^(1/2))) - 90))/180)*((15152847288669*pi)/(10000000000000*M^(3/20)) + 1)*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500))/(1800000*((10751841*M^(1929/2500))/16000000 + (284089*M^(33339/50000))/1562500 + (10751841*M^(1929/2500)*((3125000000*M^(4871/100000))/44655661557 + 11/100)^2)/1000000))
gradg4 <- -((6391*log(4680/(37*v)))/125 - 10966043/10000)*((5289050460814003*temp^4)/75557863725914323419136 - (1770887431076117*temp^3)/295147905179352825856 + temp^2/5000 - (37*temp)/10000 + 10651/10000)
gradg5 <- -MF*((6391*log(4680/(37*v)))/125 - 10966043/10000)*((5289050460814003*temp^3)/18889465931478580854784 - (5312662293228351*temp^2)/295147905179352825856 + temp/2500 - 37/10000)

gradgx <- c(gradg1,gradg2,gradg3,gradg4,gradg5)

Grad_G <- gradgx%*%Jxy
alpha  <- -Grad_G/(sqrt(sum(Grad_G^2)))

d1     <- (g/(sqrt(sum(Grad_G^2)))+alpha%*%y0)*(alpha[1])-y0[1]
d2     <- (g/(sqrt(sum(Grad_G^2)))+alpha%*%y0)*(alpha[2])-y0[2]
d3     <- (g/(sqrt(sum(Grad_G^2)))+alpha%*%y0)*(alpha[3])-y0[3]
d4     <- (g/(sqrt(sum(Grad_G^2)))+alpha%*%y0)*(alpha[4])-y0[4]
d5     <- (g/(sqrt(sum(Grad_G^2)))+alpha%*%y0)*(alpha[5])-y0[5]
d      <- c(d1,d2,d3,d4,d5)
step     <- 0.01
y0new    <- y0+step*d

U1new    <- pnorm(y0new[1],0,1)
U2new    <- pnorm(y0new[2],0,1)  
U3new    <- pnorm(y0new[3],0,1)
U4new    <- pnorm(y0new[4],0,1)
U5new    <- pnorm(y0new[5],0,1)

x1new   <- (4.38*(-log(1-U1new))^(1/1.7)) #velocity
x2new   <- invcdf(uniformdistribution(8000,260000),U2new) #displacement
x3new   <- invcdf(gammadistribution(alpha=1.19,beta=1/0.27),U3new) #angle
x4new   <- qnorm(U4new,1,0.033)
x5new   <- qnorm(U5new,15,5)

vnew      <- x1new
Mnew      <- x2new
anglesnew <- x3new
MFnew     <- x4new
tempnew   <- x5new


Lppnew   <- ((Mnew)^0.3858)*3.279
Dnew     <- ((Mnew)^0.2321)*0.9519
Bnew     <- ((Mnew)^0.33339)*0.8528
Cbnew    <- Mnew/(Lppnew*Bnew*Dnew*1.02)
Rnew     <- sqrt((Lppnew/4)^2+(Bnew/2)^2)
Knew     <- (0.19*Cbnew+0.11)*Lppnew
gammanew <- 90-anglesnew-asin(Bnew/(2*Rnew))
Cenew    <- (Knew^2+Rnew^2*(cospi(gammanew/180))^2)/(Knew^2+Rnew^2)
Cmnew    <- 1+pi*Dnew/(2*Cbnew*Bnew)
VFnew    <- -0.056*log(0.72*deflection/(0.74*vnew*10))+1.2011
TFnew    <- -3*10^-6*(tempnew^3)+0.0002*(tempnew^2)-0.0058*tempnew+1.0533
gnew     <- Ecv*VFnew*MFnew*TFnew-0.5*Mnew*(vnew/100)^2*Cmnew*Cenew

mold <- 0.5*(sqrt(sum(y0^2)))^2+10*abs(g)
mnew <- 0.5*(sqrt(sum(y0new^2)))^2+10*abs(gnew)

if(mold<mnew){stop("mold lebih kecil")}

e1<-abs(gnew-g)
print(e1)

y0 <- y0new}

beta <-(sqrt(sum(y0new^2)))
print(paste("beta=",beta))
print(paste("alpha=",alpha))

Designenergy <- 0.5*Mnew*(vnew/100)^2*Cmnew*Cenew
Designres    <- Ecv*MF*TF*VF

print(Designenergy)
print(Designres)
